name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸšš Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'

            # 1. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð° (ÐµÑÐ»Ð¸ Ð½ÐµÑ‚)
            mkdir -p ~/telegram-bot

            # 2. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð½ÐµÑ‘
            cd ~/telegram-bot

            # 3. Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ git (ÐµÑÐ»Ð¸ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ñ€Ð°Ð·)
            git init .
            git remote add origin https://github.com/$GITHUB_REPOSITORY.git 2>/dev/null || true

            # 4. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ ÐºÐ¾Ð´
            git fetch --depth=1 origin main
            git reset --hard origin/main

            # 5. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python Ð¸ pip (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
            sudo apt update && sudo apt install -y python3 python3-pip

            # 6. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            pip3 install --user -r requirements.txt

            # 7. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .env (Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½)
            echo "TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}" > .env

            # 8. ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð±Ð¾Ñ‚Ð° (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ)
            pkill -f bot.py 2>/dev/null || true

            # 9. Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð° Ð² Ñ„Ð¾Ð½Ðµ
            nohup python3 bot.py > bot.log 2>&1 &
            echo "[âœ…] Bot deployed and restarted at $(date)"

          EOF
