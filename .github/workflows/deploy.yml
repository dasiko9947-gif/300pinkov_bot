name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # 1. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð±Ð¾Ñ‚Ð° Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´
            mkdir -p /home/botuser/telegram-bot
            cd /home/botuser/telegram-bot
            
            echo "ðŸ”„ Ð—Ð°Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· GitHub..."
            git init -q
            git remote remove origin 2>/dev/null || true
            git remote add origin https://github.com/dasiko9947-gif/300pinkov_bot.git
            git fetch --depth=1 origin main -q
            git reset --hard origin/main -q

            # 2. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ venv
            echo "ðŸ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
            sudo apt update -q
            sudo apt install -y python3-venv python3-pip
            
            # 3. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼/Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°ÐµÐ¼ venv
            rm -rf venv
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip -q
            pip install -r requirements.txt -q

            # 4. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž (ÑÑ‚Ð¾ ÑÐ°Ð¼Ð¾Ðµ Ð²Ð°Ð¶Ð½Ð¾Ðµ!)
            echo "ðŸ” Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»..."
            cat > /home/botuser/telegram-bot/.env << EOL
# Telegram
TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
ADMIN_ID=${{ secrets.ADMIN_ID }}

# YooKassa
YOOKASSA_SHOP_ID=${{ secrets.YOOKASSA_SHOP_ID }}
YOOKASSA_SECRET_KEY=${{ secrets.YOOKASSA_SECRET_KEY }}

# Bank card
BANK_CARD=${{ secrets.BANK_CARD }}

# Support
SUPPORT_USERNAME=${{ secrets.SUPPORT_USERNAME }}
EOL

            # 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½
            echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°:"
            ls -la /home/botuser/telegram-bot/.env
            echo "ÐŸÐµÑ€Ð²Ñ‹Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸ (Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ ÑÐºÑ€Ñ‹Ñ‚Ñ‹):"
            head -10 /home/botuser/telegram-bot/.env | sed 's/=.*/=[ÑÐºÑ€Ñ‹Ñ‚Ð¾]/'

            # 6. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ
            echo "âš™ï¸ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ..."
            sudo tee /etc/systemd/system/telegram-bot.service > /dev/null << 'SERVICE'
[Unit]
Description=Telegram Bot 300 ÐŸÐ˜ÐÐšÐžÐ’
After=network.target

[Service]
Type=simple
User=botuser
WorkingDirectory=/home/botuser/telegram-bot
Environment="PATH=/home/botuser/telegram-bot/venv/bin"
ExecStart=/home/botuser/telegram-bot/venv/bin/python /home/botuser/telegram-bot/bot.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
SERVICE

            # 7. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
            echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°..."
            sudo systemctl daemon-reload
            sudo systemctl restart telegram-bot
            sudo systemctl enable telegram-bot

            # 8. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            sleep 3
            echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±Ð¾Ñ‚Ð°:"
            sudo systemctl status telegram-bot --no-pager | head -10
            
            echo "[âœ…] Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ Ð² $(date)"
          EOF
