# .github/workflows/deploy.yml
name: –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ Telegram-–±–æ—Ç–∞

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üöö –ö–æ–¥ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞
        uses: actions/checkout@v4

      - name: üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–∫–ª—é—á–∞
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # 1. –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è –±–æ—Ç–∞ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º —Ç—É–¥–∞
            echo "üîÑ –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –∑–∞—Ö–æ–¥–∏–º –≤ –Ω–µ—ë..."
            mkdir -p /home/botuser/telegram-bot
            cd /home/botuser/telegram-bot

            # 2. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ —Å GitHub
            echo "üì• –ó–∞–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º git, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            git init -q
            git remote remove origin 2>/dev/null || true
            git remote add origin https://github.com/dasiko9947-gif/300pinkov_bot.git
            git fetch --depth=1 origin main -q
            git reset --hard origin/main -q

            # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º venv, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            echo "üêç –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
            sudo apt update -q
            sudo apt install -y python3-venv python3-pip -q

            # 4. –°–æ–∑–¥–∞–µ–º/–ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º venv –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "üîß –°–æ–∑–¥–∞—ë–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞–∫–µ—Ç—ã..."
            rm -rf venv
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip -q
            if [ -f requirements.txt ]; then
                pip install -r requirements.txt -q
                echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã."
            else
                echo "‚ö†Ô∏è –§–∞–π–ª requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω."
            fi

            # 5. –û–±–Ω–æ–≤–ª—è–µ–º .env —Ñ–∞–π–ª
            echo "üîê –°–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º .env —Ñ–∞–π–ª..."
            cat > .env << EOL
TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
EOL
            echo "‚úÖ .env —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª—ë–Ω."

            # 6. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º systemd-—Å–µ—Ä–≤–∏—Å
            echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Telegram-–±–æ—Ç–∞..."
            sudo systemctl restart telegram-bot

            # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            sleep 3
            echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:"
            sudo systemctl status telegram-bot --no-pager -l | head -10

            echo "[‚úÖ] –ë–æ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∏ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –≤ $(date)"
          EOF
