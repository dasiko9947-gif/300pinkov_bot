name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°
            mkdir -p ~/telegram-bot
            cd ~/telegram-bot

            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ñ GitHub
            git init .
            git remote add origin https://github.com/dasiko9947-gif/300pinkov_bot.git
            git fetch --depth=1 origin main
            git reset --hard origin/main

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ venv, ÐµÑÐ»Ð¸ Ð½ÐµÑ‚
            sudo apt update && sudo apt install -y python3-venv
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ .env Ð’Ð¡Ð•ÐœÐ˜ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ð¼Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸
            cat > .env << 'ENVFILE'
            # Telegram
            TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
            ADMIN_ID=${{ secrets.ADMIN_ID }}
            SUPPORT_USERNAME=${{ secrets.SUPPORT_USERNAME }}
            
            # Ð®Kassa Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð¸
            YOOKASSA_SHOP_ID=${{ secrets.YOOKASSA_SHOP_ID }}
            YOOKASSA_SECRET_KEY=${{ secrets.YOOKASSA_SECRET_KEY }}
            
            # Ð‘Ð°Ð½ÐºÐ¾Ð²ÑÐºÐ°Ñ ÐºÐ°Ñ€Ñ‚Ð° Ð´Ð»Ñ Ñ€ÑƒÑ‡Ð½Ñ‹Ñ… Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð¾Ð² (Ð¿Ð°Ñ€Ð½Ñ‹Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸)
            BANK_CARD=${{ secrets.BANK_CARD }}
            ENVFILE

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
            echo "ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ JSON Ñ„Ð°Ð¹Ð»Ñ‹ ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
            touch users_data.json tasks_data.json payments_data.json invite_codes.json
            
            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð°
            chmod 644 *.json

            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ systemd-ÑÐµÑ€Ð²Ð¸Ñ
            sudo systemctl restart telegram-bot
            echo "[âœ…] Bot deployed and restarted at $(date)"
          EOF

      - name: ðŸ“ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´ÐµÐ¿Ð»Ð¾Ñ
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ~/telegram-bot
            echo "=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´ÐµÐ¿Ð»Ð¾Ñ ==="
            echo "1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°:"
            if [ -f .env ]; then
              echo "âœ… .env ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"
              # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð¼ÐµÐ½Ð° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… (Ð±ÐµÐ· Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹)
              echo "   ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ:"
              cat .env | grep -E '^[A-Z_]' | cut -d= -f1 | sed 's/^/   - /'
            else
              echo "âŒ .env Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
            fi
            
            echo "2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°:"
            if systemctl is-active --quiet telegram-bot; then
              echo "âœ… Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
              echo "   Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:"
              systemctl status telegram-bot --no-pager | head -10
            else
              echo "âŒ Ð‘Ð¾Ñ‚ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½"
            fi
            
            echo "3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5 ÑÑ‚Ñ€Ð¾Ðº):"
            journalctl -u telegram-bot -n 5 --no-pager
            
            echo "=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ==="
          EOF
