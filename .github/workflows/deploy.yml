name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # 1. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð±Ð¾Ñ‚Ð° Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´
            mkdir -p ~/telegram-bot
            cd ~/telegram-bot
            
            echo "ðŸ”„ Ð—Ð°Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· GitHub..."
            git init
            git remote remove origin 2>/dev/null || true
            git remote add origin https://github.com/dasiko9947-gif/300pinkov_bot.git
            git fetch --depth=1 origin main
            git reset --hard origin/main

            # 2. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ venv, ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚ (Ubuntu 24.04+)
            echo "ðŸ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
            sudo apt update -q
            sudo apt install -y python3-venv python3-pip[citation:1]
            
            # 3. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼/Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°ÐµÐ¼ venv Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            rm -rf venv
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # 4. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÑÐ¾ Ð’Ð¡Ð•ÐœÐ˜ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸
            echo "ðŸ” ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»..."
            cat > .env << 'ENVFILE'
            TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
            ADMIN_ID=${{ secrets.ADMIN_ID }}
            YOOKASSA_SHOP_ID=${{ secrets.YOOKASSA_SHOP_ID }}
            YOOKASSA_SECRET_KEY=${{ secrets.YOOKASSA_SECRET_KEY }}
            BANK_CARD=${{ secrets.BANK_CARD }}
            SUPPORT_USERNAME=${{ secrets.SUPPORT_USERNAME }}
            ENVFILE

            # 5. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ systemd ÑÐµÑ€Ð²Ð¸ÑÐ° (Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½ ExecStart)
            echo "âš™ï¸ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ..."
            sudo tee /etc/systemd/system/telegram-bot.service > /dev/null << 'SERVICEUNIT'
            [Unit]
            Description=Telegram Bot 300 ÐŸÐ˜ÐÐšÐžÐ’
            After=network.target

            [Service]
            Type=simple
            User=botuser
            WorkingDirectory=/home/botuser/telegram-bot
            Environment="PATH=/home/botuser/telegram-bot/venv/bin"
            ExecStart=/home/botuser/telegram-bot/venv/bin/python /home/botuser/telegram-bot/bot.py[citation:2][citation:8]
            Restart=always
            RestartSec=10

            [Install]
            WantedBy=multi-user.target
            SERVICEUNIT

            # 6. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ systemd Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
            echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°..."
            sudo systemctl daemon-reload[citation:5]
            sudo systemctl restart telegram-bot
            sudo systemctl enable telegram-bot[citation:2][citation:5]

            echo "[âœ…] Ð‘Ð¾Ñ‚ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð² $(date)"
            EOF
