name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # 1. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð±Ð¾Ñ‚Ð° Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´
            mkdir -p /home/botuser/telegram-bot
            cd /home/botuser/telegram-bot
            
            echo "ðŸ”„ Ð—Ð°Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· GitHub..."
            git init -q
            git remote remove origin 2>/dev/null || true
            git remote add origin https://github.com/dasiko9947-gif/300pinkov_bot.git
            git fetch --depth=1 origin main -q
            git reset --hard origin/main -q

            # 2. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ venv ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
            echo "ðŸ ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² Ð¿ÐµÑ€ÐµÐ´ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹
            sudo apt update -q
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ Ð»Ð¸ ÑƒÐ¶Ðµ python3-venv Ð¸ python3-pip
            if ! command -v python3-venv &> /dev/null || ! dpkg -l | grep -q python3-venv; then
              sudo apt install -y python3-venv
            fi
            if ! command -v pip3 &> /dev/null || ! dpkg -l | grep -q python3-pip; then
              sudo apt install -y python3-pip
            fi

            # 3. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼/Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°ÐµÐ¼ venv
            echo "ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ..."
            rm -rf venv
            python3 -m venv venv
            source venv/bin/activate

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ requirements.txt Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            if [ -f requirements.txt ]; then
                echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸Ð· requirements.txt..."
                pip install --upgrade pip -q
                pip install -r requirements.txt -q
                echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹."
            else
                echo "âš ï¸ Ð¤Ð°Ð¹Ð» requirements.txt Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸."
            fi

            # 4. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÐŸÐ ÐÐ’Ð˜Ð›Ð¬ÐÐž (ÑÑ‚Ð¾ ÑÐ°Ð¼Ð¾Ðµ Ð²Ð°Ð¶Ð½Ð¾Ðµ!)
            echo "ðŸ” Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð»..."
            cat > /home/botuser/telegram-bot/.env << EOL
# Telegram
TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}
ADMIN_ID=${{ secrets.ADMIN_ID }}

# YooKassa
YOOKASSA_SHOP_ID=${{ secrets.YOOKASSA_SHOP_ID }}
YOOKASSA_SECRET_KEY=${{ secrets.YOOKASSA_SECRET_KEY }}

# Bank card
BANK_CARD=${{ secrets.BANK_CARD }}

# Support
SUPPORT_USERNAME=${{ secrets.SUPPORT_USERNAME }}
EOL

            # 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½
            echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ°:"
            ls -la /home/botuser/telegram-bot/.env
            # Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ Ð·Ð°Ð¼Ð°ÑÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸
            echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ .env (Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ ÑÐºÑ€Ñ‹Ñ‚Ñ‹):"
            sed 's/=.*/=[ÑÐºÑ€Ñ‹Ñ‚Ð¾]/' /home/botuser/telegram-bot/.env

            # 6. ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ
            echo "âš™ï¸ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ systemd ÑÐµÑ€Ð²Ð¸Ñ..."
            sudo tee /etc/systemd/system/telegram-bot.service > /dev/null << 'SERVICE'
[Unit]
Description=Telegram Bot 300 ÐŸÐ˜ÐÐšÐžÐ’
After=network.target

[Service]
Type=simple
User=botuser
WorkingDirectory=/home/botuser/telegram-bot
Environment="PATH=/home/botuser/telegram-bot/venv/bin"
ExecStart=/home/botuser/telegram-bot/venv/bin/python /home/botuser/telegram-bot/bot.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
SERVICE

            # 7. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
            echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°..."
            sudo systemctl daemon-reload
            sudo systemctl restart telegram-bot
            sudo systemctl enable telegram-bot

            # 8. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            sleep 3
            echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±Ð¾Ñ‚Ð°:"
            sudo systemctl status telegram-bot --no-pager -l | head -15
            
            echo "[âœ…] Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð²ÐµÑ€Ð½ÑƒÑ‚ Ð² $(date)"
          EOF
