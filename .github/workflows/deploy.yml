name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è SSH
          DEPLOY_SCRIPT=$(cat << 'SSH_SCRIPT'
          # 1. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –±–æ—Ç–∞
          mkdir -p /home/botuser/telegram-bot
          cd /home/botuser/telegram-bot
          
          echo "üîÑ –°–æ–∑–¥–∞—ë–º –±—ç–∫–∞–ø –¥–∞–Ω–Ω—ã—Ö..."
          cp users_data.json users_data.json.backup 2>/dev/null || echo "users_data.json –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
          cp stages.json stages.json.backup 2>/dev/null || echo "stages.json –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
          cp payments_data.json payments_data.json.backup 2>/dev/null || echo "payments_data.json –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
          cp invite_codes.json invite_codes.json.backup 2>/dev/null || echo "invite_codes.json –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"

          echo "üîÑ –ó–∞–±–∏—Ä–∞–µ–º –∫–æ–¥ –∏–∑ GitHub..."
          git init -q
          git remote remove origin 2>/dev/null || true
          git remote add origin https://github.com/dasiko9947-gif/300pinkov_bot.git  
          git fetch --depth=1 origin main -q
          git reset --hard origin/main -q

          echo "üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ..."
          cp users_data.json.backup users_data.json 2>/dev/null || echo "users_data.json.backup –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
          cp stages.json.backup stages.json 2>/dev/null || echo "stages.json.backup –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
          cp payments_data.json.backup payments_data.json 2>/dev/null || echo "payments_data.json.backup –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
          cp invite_codes.json.backup invite_codes.json 2>/dev/null || echo "invite_codes.json.backup –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"

          # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º venv
          echo "üêç –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
          sudo apt update -q
          sudo apt install -y python3-venv python3-pip
          
          # 3. –°–æ–∑–¥–∞–µ–º/–ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º venv
          rm -rf venv
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip -q
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt -q
          else
            pip install aiogram yookassa apscheduler python-dotenv pytz aiofiles requests watchdog -q
          fi

          # 4. –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª
          echo "üîê –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª..."
          cat > .env << 'ENV_CONFIG'
          TELEGRAM_TOKEN=$TELEGRAM_TOKEN
          ADMIN_ID=$ADMIN_ID
          YOOKASSA_SHOP_ID=$YOOKASSA_SHOP_ID
          YOOKASSA_SECRET_KEY=$YOOKASSA_SECRET_KEY
          BANK_CARD=$BANK_CARD
          SUPPORT_USERNAME=$SUPPORT_USERNAME
          ENV_CONFIG

          # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª
          echo "‚úÖ .env —Å–æ–∑–¥–∞–Ω. –ö–ª—é—á–∏:"
          grep -o '^[^=]*' .env

          # 6. Systemd —Å–µ—Ä–≤–∏—Å
          echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º systemd..."
          sudo tee /etc/systemd/system/telegram-bot.service > /dev/null << 'SERVICE_CONFIG'
          [Unit]
          Description=Telegram Bot 300 –ü–ò–ù–ö–û–í
          After=network.target

          [Service]
          Type=simple
          User=botuser
          WorkingDirectory=/home/botuser/telegram-bot
          Environment="PATH=/home/botuser/telegram-bot/venv/bin"
          ExecStart=/home/botuser/telegram-bot/venv/bin/python /home/botuser/telegram-bot/bot.py
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          SERVICE_CONFIG

          # 7. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
          echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞..."
          sudo systemctl daemon-reload
          sudo systemctl restart telegram-bot
          sudo systemctl enable telegram-bot

          # 8. –ü—Ä–æ–≤–µ—Ä–∫–∞
          sleep 2
          echo "üìä –°—Ç–∞—Ç—É—Å:"
          sudo systemctl status telegram-bot --no-pager | head -5
          
          echo "[‚úÖ] –ë–æ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –≤ $(date)"
          SSH_SCRIPT
          )

          # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Å–∫—Ä–∏–ø—Ç–µ
          DEPLOY_SCRIPT=${DEPLOY_SCRIPT//\$TELEGRAM_TOKEN/${{ secrets.TELEGRAM_TOKEN }}}
          DEPLOY_SCRIPT=${DEPLOY_SCRIPT//\$ADMIN_ID/${{ secrets.ADMIN_ID }}}
          DEPLOY_SCRIPT=${DEPLOY_SCRIPT//\$YOOKASSA_SHOP_ID/${{ secrets.YOOKASSA_SHOP_ID }}}
          DEPLOY_SCRIPT=${DEPLOY_SCRIPT//\$YOOKASSA_SECRET_KEY/${{ secrets.YOOKASSA_SECRET_KEY }}}
          DEPLOY_SCRIPT=${DEPLOY_SCRIPT//\$BANK_CARD/${{ secrets.BANK_CARD }}}
          DEPLOY_SCRIPT=${DEPLOY_SCRIPT//\$SUPPORT_USERNAME/${{ secrets.SUPPORT_USERNAME }}}

          # –í—ã–ø–æ–ª–Ω—è–µ–º SSH
          ssh -i ~/.ssh/id_ed25519 \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
          $DEPLOY_SCRIPT
          EOF
