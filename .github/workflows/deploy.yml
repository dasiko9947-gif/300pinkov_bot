name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]  # Ð¸Ð»Ð¸ master â€” ÑÐ¼Ð¾Ñ‚Ñ€Ð¸ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð²ÐµÑ‚ÐºÐ¸ Ñƒ Ñ‚ÐµÐ±Ñ

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Checkout
        uses: actions/checkout@v4

      - name: ðŸ”‘ Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to server
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            mkdir -p ~/telegram-bot
            cd ~/telegram-bot

            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ñ GitHub
            git init .
            git remote add origin https://github.com/dasiko9947-gif/300pinkov_bot.git
            git fetch --depth=1 origin main
            git reset --hard origin/main

            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            sudo apt update && sudo apt install -y python3 python3-pip
            pip3 install --user -r requirements.txt 2>/dev/null || echo "requirements.txt missing or empty"

            # ÐŸÐ¾Ð´ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½
            echo "TELEGRAM_TOKEN=${{ secrets.TELEGRAM_TOKEN }}" > .env

            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð±Ð¾Ñ‚Ð°
            pkill -f bot.py 2>/dev/null || true
            nohup python3 bot.py > bot.log 2>&1 &
            echo "[âœ…] Bot deployed at $(date)"
          EOF
